#!/bin/bash

# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

# Function to display help menu
help_menu() {
    echo "Usage: $0 <domain>"
    echo "Search for domain information."
    echo ""
    echo "Options:"
    echo "  -h, --help    Display this help menu"
    exit 0
}

# Parse command-line arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) help_menu ;;
        *) domain="$1" ;;
    esac
    shift
done

# Input validation
if [ -z "$domain" ] || [[ "$domain" == "-h" ]] || [[ "$domain" == "--help" ]]; then
    help_menu
fi

# Function to start the process
start_func() {
    echo "[*] $1"
}

# Function to end the process
end_func() {
    echo "[+] $1"
}

# Main function to gather domain info
domain_info_func() {
    if { [ ! -f "$called_fn_dir/.domain_info" ]; } && [ "$DOMAIN_INFO" = true ] && [ "$OSINT" = true ] && ! [[ $domain =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9] ]]; then
        start_func "Searching domain info (whois, registrant name/email domains)"
        
        # Domain General Info
        whois -H $domain > osint/domain_info_general.txt || { echo "whois command failed"; exit 1; }
        
        # Reverse Whois (if DEEP or REVERSE_WHOIS is true)
        if [ "$DEEP" = true ] || [ "$REVERSE_WHOIS" = true ]; then
            timeout -k 1m ${AMASS_INTEL_TIMEOUT}m amass intel -d ${domain} -whois -timeout $AMASS_INTEL_TIMEOUT -o osint/domain_info_reverse_whois.txt 2>>"$LOGFILE" &>/dev/null
        fi
        
        # Azure Tenant Domains
        curl -s "https://aadinternals.azurewebsites.net/api/tenantinfo?domainName=${domain}" -H "Origin: https://aadinternals.com" | jq -r .domains[].name > osint/azure_tenant_domains.txt

        end_func "Results are saved in $domain/osint/domain_info_[general/name/email/ip].txt"
    else
        echo "Skipped domain_info due to conditions or configuration."
    fi
}

# Call the main function
domain_info_func
