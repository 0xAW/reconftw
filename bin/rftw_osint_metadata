#!/bin/bash

# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

# Define global variables
called_fn_dir="/path/to/called_fn_dir"
LOGFILE="/path/to/logfile"
METAFINDER_LIMIT=100
domain=$1

function gather_metadata() {
    if { [ ! -f "$called_fn_dir/.metadata" ] || [ "$DIFF" = true ]; } && [ "$METADATA" = true ] && [ "$OSINT" = true ] && ! [[ $domain =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9] ]]; then
        echo -e "${yellow}Scanning metadata in public files${reset}"
        
        metafinder -d "$domain" -l $METAFINDER_LIMIT -o osint -go -bi -ba &>> "$LOGFILE" || { echo "metafinder command failed"; exit 1; }
        mv "osint/${domain}/"*".txt" "osint/" 2>>"$LOGFILE"
        rm -rf "osint/${domain}" 2>>"$LOGFILE"
        echo "Results are saved in $domain/osint/[software/authors/metadata_results].txt"
    elif [ "$METADATA" = false ] || [ "$OSINT" = false ]; then
        echo -e "${yellow}metadata skipped as defined in reconftw.cfg${reset}"
    else
        echo -e "${yellow}metadata is already processed or input is an IP. To force, delete\n    $called_fn_dir/.metadata${reset}"
    fi
}

function main() {
    if [ -z "$domain" ]; then
        echo "Usage: $0 <domain>"
        exit 1
    fi
    gather_metadata
}

main
