#!/bin/bash
# Looks good, needs testing

# Load environment variables
if [ -f "reconftw.cfg" ]; then
    source reconftw.cfg
else
    echo "Error: reconftw.cfg not found!"
    exit 1
fi

help_menu() {
  echo "Usage: $0 [OPTIONS] DOMAIN"
  echo ""
  echo "Favicon Ip Lookup Tool"
  echo ""
  echo "Options:"
  echo "  -h, --help            Show this help menu"
  echo "  -d, --domain DOMAIN   Specify the domain to process"
  echo "  -f, --force           Force the execution even if already processed"
}

# Start function
start_func() {
    echo "Starting $1..."
}

# End function
end_func() {
    echo "$1"
    echo "End of $2..."
}

# Default values
FORCE=false
DOMAIN=""

# Parse arguments
while [[ "$#" -gt 0 ]]; do
  case $1 in
    -h|--help) help_menu; exit 0 ;;
    -d|--domain) DOMAIN="$2"; shift ;;
    -f|--force) FORCE=true ;;
    *)
      # Set the domain if it's not specified with -d
      [ -z "$DOMAIN" ] && DOMAIN="$1" || { echo "Unknown parameter passed: $1"; exit 1; }
      ;;
  esac
  shift
done

# Input validation
if [ -z "$DOMAIN" ]; then
  help_menu
  exit 1
fi

# Validate domain format
if [[ ! "$DOMAIN" =~ ^[a-zA-Z0-9.-]+$ ]]; then
    echo "Invalid domain format."
    exit 1
fi

if { [ ! -f "$called_fn_dir/.favicon" ] || [ "$FORCE" = true ]; } && [ "$FAVICON" = true ] && ! [[ $DOMAIN =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9] ]]; then
    start_func "Favicon Ip Lookup"
    
    cd "$tools/fav-up" || { echo "Failed to cd to $tools/fav-up in favicon"; exit 1; }
    python3 favUp.py -w "$DOMAIN" -sc -o favicontest.json 2>>"$LOGFILE" >/dev/null

    if [ -s "favicontest.json" ]; then
        jq -r 'try .found_ips' favicontest.json 2>>"$LOGFILE" | grep -v "not-found" > favicontest.txt
        sed -i "s/|/\n/g" favicontest.txt
        cat favicontest.txt 2>>"$LOGFILE"
        mv favicontest.txt $dir/hosts/favicontest.txt 2>>"$LOGFILE"
        rm -f favicontest.json 2>>"$LOGFILE"
    fi

    cd "$dir" || { echo "Failed to cd to $dir in favicon"; exit 1; }
    end_func "Results are saved in hosts/favicontest.txt" "favicon"
else
    if [ "$FAVICON" = false ] || [[ $DOMAIN =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9] ]]; then
        echo -e "\n${yellow} favicon skipped in this mode, defined in reconftw.cfg, or the domain is an IP address${reset}\n"
    else
        echo -e "${yellow} favicon is already processed. To force executing favicon, delete\n    $called_fn_dir/.favicon ${reset}\n\n"
    fi
fi
